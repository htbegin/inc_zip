# 增量备份软件设计文档

本文档详细分析了基于ZIP格式的增量备份软件的需求、设计、实现方案及核心技术点。

## 1. 需求分析

### 1.1. 功能需求

核心功能是创建一个新的增量备份ZIP文件，该文件记录了自上一个备份状态（由基础ZIP和所有旧的增量ZIP构成）以来的所有变更。

**基本变更类型:**

1.  **新增文件 (Added):** 存在于最新文件目录，但不存在于任何历史备份中的文件。
2.  **修改文件 (Modified):** 在最新文件目录和历史备份中都存在，但内容已发生变化的文件。
3.  **删除文件 (Deleted):** 存在于历史备份中，但已从最新文件目录中移除的文件。
4.  **未变文件 (Unchanged):** 内容和路径都未发生变化的文件，无需处理。

**关键设计点：处理删除**

由于ZIP的追加特性，无法物理删除文件。因此，每个增量包 `inc_N.zip` 必须包含一个**元数据文件（例如 `.manifest.json`）**，用于记录被删除文件的列表。

**恢复流程:**

1.  解压 `base.zip` 到目标目录。
2.  依次解压 `inc_1.zip`, `inc_2.zip`, ..., `inc_N.zip`，并覆盖目标目录中的同名文件。
3.  读取所有增量包中的 manifest 文件，并根据累积的删除列表，从目标目录中删除相应的文件。

### 1.2. 与 7-Zip 增量备份对比

- **7-Zip 模式:** 7-Zip 的更新模式是“归档替换”，即创建一个包含所有变更的新归档来替换旧归档。它通过在生成新归档时“不包含”已删除文件的条目来实现删除。
- **本软件模式:** 采用“增量链”模型，保留 `base.zip`, `inc_1.zip`... 的历史，更便于版本回溯。这种模式**必须**依赖外部机制（如 manifest 文件）来记录删除。

### 1.3. 性能需求 (处理200万文件)

-   **CPU占用率:** 主要消耗在**文件哈希计算**和**ZIP压缩**上，可通过并行化大幅提升效率。
-   **内存占用 (RAM):** 核心挑战。需要加载历史备份和当前目录的元数据索引。预估内存峰值在 `800MB` 左右，在现代服务器上可接受，但需高效管理。
-   **执行时间 (Execution Time):** 主要瓶颈是磁盘I/O。必须通过并行处理和高效的变更判断算法（见下文）来缩短时间。

## 2. 可行实现方法分析

### 2.1. 核心算法（语言无关）

1.  **构建历史状态索引:** 高效地读取所有历史ZIP文件的**中央目录**（而非解压），将文件路径、修改时间、大小和CRC-32校验和加载到内存中的一个哈希表（快照）中。同时处理 manifest 中记录的删除信息。
2.  **构建当前状态索引:** 并行地遍历最新的文件目录，获取每个文件的元数据。
3.  **计算变更集 (Diff):**
    - **快速判断:** 优先比较**修改时间**和**文件大小**。不匹配则为“修改”。
    - **精确判断:** 若时间大小匹配，再根据用户选择的模式，计算文件的**CRC-32**并与快照对比，以100%确定文件内容是否变更。
    - 找出历史快照中有但当前目录没有的文件，记为“删除”。
4.  **生成新的增量包:** 并行地将“新增”和“修改”的文件压缩进新的ZIP包，同时生成记录“删除”文件列表的 manifest 文件并存入。

### 2.2. Python vs. C/C++

| 特性 | Python | C/C++ | 推荐策略 |
| :--- | :--- | :--- | :--- |
| **开发效率** | **极高** | 低 | **首选Python** |
| **执行性能** | 中-高 (通过并行优化) | **极高** | Python性能足够，瓶颈在I/O |
| **内存占用** | 中等 | **低** | Python可接受，或用SQLite优化 |
| **健壮性/维护**| 良好 | 较差 (更复杂) | Python更易维护 |

**结论：** 强烈建议使用 **Python** 实现。其开发效率极高，且通过 `concurrent.futures` 等库可以很好地并行化处理I/O和CPU密集型任务，性能足以满足需求。

## 3. 核心问题深入分析

### 3.1. 如何利用ZIP中央目录判断文件变更

ZIP中央目录为每个文件存储了`修改时间`、`未压缩大小`和`CRC-32`校验和。这为我们提供了完美的“两步验证法”：

1.  **快速筛选 (快):** 比较`修改时间` + `大小`。这能过滤掉99%的未变文件，且开销极小。
2.  **精确校验 (准):** 如果上一步匹配，再计算文件内容的`CRC-32`并与记录值对比。这能100%捕获内容变更，但开销较大。

### 3.2. 如何处理文件删除

如前所述，在“增量链”模型中，记录删除信息是必需的。

- **最佳方案:** 在增量包中使用 `.manifest.json` 文件。它清晰、可扩展、易于解析，是行业标准做法。
- **其他方案 (不推荐):** “墓碑”文件或利用ZIP注释，这些方法或约定脆弱，或滥用格式，均不如 Manifest 文件健壮。
